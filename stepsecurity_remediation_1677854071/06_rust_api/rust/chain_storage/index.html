<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Block storage crate."><meta name="keywords" content="rust, rustlang, rust-lang, chain_storage"><title>chain_storage - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../normalize.css"><link rel="stylesheet" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../ayu.css" disabled><link rel="stylesheet" href="../dark.css" disabled><link rel="stylesheet" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../chain_storage/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../chain_storage/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate chain_storage</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.1.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../chain_storage/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">chain_storage</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/chain_storage/lib.rs.html#1-153">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Block storage crate.</p>
<h2 id="data-model"><a href="#data-model">Data model</a></h2>
<p>This storage is designed to be independent from a particular block strucure.
At the same time, since it is designed specifically for block chains, it
handles the minimum amount of data required to maintain consistency. Such
data includes:</p>
<ul>
<li>Block ID</li>
<li>ID of the parent block</li>
<li>Chain length</li>
</ul>
<p>This data is provided alongside a block in the <code>BlockInfo</code> structure.</p>
<h2 id="volatile--permanent-storage-model"><a href="#volatile--permanent-storage-model">Volatile + permanent storage model</a></h2>
<p>Since blockchain can be branching extensively, this library provides the
mechanism to have multiple blockchain branches. However, doing so for all
block screates a lot of overhead for maintaining volatile storage. At the
same time, branches usually die out pretty fast.</p>
<p>Given that, the storage is separated into two parts:</p>
<ul>
<li>Volatile storage should be used for the part of a blockchain where a
developer may need access to different branches.</li>
<li>Permanent storage for the part of the blockchain that is guaranteed not to
change anymore.</li>
</ul>
<h3 id="moving-blocks-to-the-permanent-store"><a href="#moving-blocks-to-the-permanent-store">Moving blocks to the permanent store.</a></h3>
<p>if you have this block structure and call
<code>store.flush_to_permanent_store(block 2 id)</code>, then <code>block 1</code> and <code>block 2</code>
will be moved to the permanent storage. if you call
<code>store.flush_to_permanent_store(block 3 id)</code>, <code>block 3</code> will also be moved
to the permanent store, but <code>block 3'</code> will still exist in the volatile store.
note that if you call <code>store.get_blocks_by_chain_length(3)</code> only <code>block 3</code>
(which is in the permanent store) will be returned; and you cannot call
<code>store.flush_to_permanent_store(block 3' id)</code> now.</p>
<p><strong>fig.1 - note that root does not actually exist, this is an id referredby</strong>
<strong>the first block in the chain</strong></p>
<div class="example-wrap"><pre class="language-text"><code>+---------+       +---------+
|         |       |         |
| block 4 |       | block 4&#39;|
|         |       |         |
+---------+       +---------+
     |                 |
     |                 |
     v                 v
+---------+       +---------+
|         |       |         |
| block 3 |       | block 3&#39;|
|         |       |         |
+---------+       +---------+
     |                 |
     |                 |
     v                 |
+---------+            |
|         |            |
| block 2 +&lt;-----------+
|         |
+---------+
     |
     |
     v
+---------+
|         |
| block 1 |
|         |
+---------+
     |
     |
     v
+---------+
|         |
|  (root) |
|         |
+---------+</code></pre></div><h3 id="removing-stale-branches"><a href="#removing-stale-branches">Removing stale branches</a></h3>
<p>If you want to clean up branches, do the following:</p>
<ul>
<li>Call <code>store.get_tips_ids()</code>, in our example it will return
<code>[Block 4 id, Block 4' id]</code>;</li>
<li>Determine which branches do you want to remove.</li>
<li>Call, for example, <code>store.prune_branch(Block 4' id)</code>.</li>
</ul>
<h3 id="performance-benefits-of-permanent-storage"><a href="#performance-benefits-of-permanent-storage">Performance benefits of permanent storage</a></h3>
<p>Since blocks in the permanent storage are stored just one after another (the
structure is <code>block_length.to_le_bytes() ++ block_bytes</code> and a file with
references to blocks in the order they were added to the storage), it allows
for the following scenarios:</p>
<ul>
<li>Very fast block iteration</li>
<li>Transferring a portion of the data file over the network without locking
it.</li>
<li>O(1) access by chain length.</li>
</ul>
<p><strong>fig. 2 - permanent storage structure</strong></p>
<div class="example-wrap"><pre class="language-text"><code>store                  block no. index

+--------------+       +-------------+
|              |       |             |
| block1       |       | block1 pos  |
|              |       |             |
+--------------+       +-------------+
|              |       |             |
| block2       |       | block2 pos  |
|              |       |             |
+--------------+       +-------------+
|              |       |             |
| ...          |       | ...         |
|              |       |             |
+--------------+       +-------------+
|              |       |             |
| blockn       |       | blockn pos  |
|              |       |             |
+--------------+       +-------------+</code></pre></div><h2 id="storage-directory-layout"><a href="#storage-directory-layout">Storage directory layout</a></h2><div class="example-wrap"><pre class="language-text"><code>store
├── permanent       - permanent storage directory
│   └── flatfile    - storage file that can be transferred over the network
└── volatile        - volatile storage</code></pre></div></div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="test_utils/index.html" title="chain_storage::test_utils mod">test_utils</a></div><div class="item-right docblock-short">Utilities for testing the storage.</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.BlockInfo.html" title="chain_storage::BlockInfo struct">BlockInfo</a></div><div class="item-right docblock-short">A structure that holds the information about a blocks, that is needed to
maintain consistency of the storage. This include the ID of the blocks, the
ID of its parent and the length of the block chain for the given block.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.BlockStore.html" title="chain_storage::BlockStore struct">BlockStore</a></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.StorageIterator.html" title="chain_storage::StorageIterator struct">StorageIterator</a></div><div class="item-right docblock-short">Iterator over blocks. Starts from n-th ancestor of the given block.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Value.html" title="chain_storage::Value struct">Value</a></div><div class="item-right docblock-short">Wrapper for data held by the database. This wrapper holds structs returned
by both volatile and permanent storage to ensure we don’t have needless
copying on return. Data should be accessed through the <code>AsRef</code> trait.</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.ConsistencyFailure.html" title="chain_storage::ConsistencyFailure enum">ConsistencyFailure</a></div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.Error.html" title="chain_storage::Error enum">Error</a></div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="chain_storage" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>